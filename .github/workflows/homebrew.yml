name: Update Homebrew Formula

on:
  release:
    types: [published]

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for release assets
        run: sleep 60  # Give release workflow time to upload artifacts

      - name: Get release info
        id: release
        run: |
          echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Download checksums
        run: |
          curl -sL "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/checksums.txt" -o checksums.txt
          cat checksums.txt

      - name: Parse checksums
        id: checksums
        run: |
          echo "aarch64_darwin=$(grep aarch64-apple-darwin checksums.txt | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "x86_64_darwin=$(grep x86_64-apple-darwin checksums.txt | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "x86_64_linux=$(grep x86_64-unknown-linux-gnu checksums.txt | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Checkout homebrew-stacy
        uses: actions/checkout@v4
        with:
          repository: janfasnacht/homebrew-stacy
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Update formula
        run: |
          cat > Formula/stacy.rb << 'EOF'
          # typed: false
          # frozen_string_literal: true

          class Stacy < Formula
            desc "Reproducible Stata projects through lockfiles and exit codes"
            homepage "https://github.com/janfasnacht/stacy"
            license "MIT"
            version "${{ steps.release.outputs.version }}"

            on_macos do
              on_arm do
                url "https://github.com/janfasnacht/stacy/releases/download/v#{version}/stacy-v#{version}-aarch64-apple-darwin.tar.gz"
                sha256 "${{ steps.checksums.outputs.aarch64_darwin }}"
              end
              on_intel do
                url "https://github.com/janfasnacht/stacy/releases/download/v#{version}/stacy-v#{version}-x86_64-apple-darwin.tar.gz"
                sha256 "${{ steps.checksums.outputs.x86_64_darwin }}"
              end
            end

            on_linux do
              url "https://github.com/janfasnacht/stacy/releases/download/v#{version}/stacy-v#{version}-x86_64-unknown-linux-gnu.tar.gz"
              sha256 "${{ steps.checksums.outputs.x86_64_linux }}"
            end

            def install
              bin.install "stacy"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/stacy --version")
            end
          end
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/stacy.rb
          git commit -m "Update stacy to ${{ github.ref_name }}"
          git push
